<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MathMania Rapid Round</title>
    <!-- Load Tailwind CSS CDN for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons as a font library for use in JS -->
    <link href="https://cdn.jsdelivr.net/npm/lucide-static@latest/font/lucide.css" rel="stylesheet">
    
    <!-- Configure and load MathJax for LaTeX/math rendering -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
    </script>

    <style>
        /* Custom styles for the icons */
        .lucide {
            display: inline-block;
            width: 1em;
            height: 1em;
            stroke-width: 2;
            stroke: currentColor;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        /* Hide F12 key functionality and right-click for security */
        body {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-start pt-10 pb-10 p-4">

    <!-- Main Application Root Container -->
    <div id="app-root" class="flex flex-col items-center w-full">
        <!-- Content will be injected here by JavaScript -->
        <div class="text-xl text-indigo-700">Loading MathMania Quiz...</div>
    </div>

    <script>
        // --- Icon Mapping Utility ---
        // Helper function to map Lucide names to CSS classes for pure JS
        const icon = (name, className = "w-6 h-6 mr-2") => {
            return `<i class="lucide lucide-${name} ${className}"></i>`;
        };

        // --- Configuration Data ---
        const SCHOOL_LOGO_URL = "https://placehold.co/150x50/3730a3/ffffff?text=SCHOOL+LOGO"; 
        const MANUAL_SUBMISSION_CODE = "MMQUIZ-2025-SPRING"; 
        const QUIZ_DATA_CONFIG = {
            title: "MathMania Rapid Round",
            subtitle: "Grade 7 Challenge", 
            questionsPerSet: 5,
            googleFormLink: "https://forms.gle/TF4N5rrGsBnrzroJA",
            sets: [
                { id: 'set1', name: "Set A", questions: [
                    { id: 1, text: "A shirt costs ₹500. If a discount of 20% is offered, what is the final selling price of the shirt?", answer: "400" },
                    { id: 2, text: "If a car travels at 60 km/hr for 15 minutes, how much distance has it covered in kilometers?", answer: "15" },
                    { id: 3, text: "If the side of a square is 10 cm, by what percentage has the perimeter increased if the side is increased by 2 cm?", answer: "20%" },
                    { id: 4, text: "Solve for x: $4x - 5 = x + 7$.", answer: "x=4" },
                    { id: 5, text: "A person walks 9 km North and 12 km East. How far is the person from the starting point, in km?", answer: "15" },
                ]},
                { id: 'set2', name: "Set B", questions: [
                    { id: 6, text: "A rectangle is three times as long as it is wide. If the width is 4 cm, what is its area in $\\text{cm}^2$?", answer: "48" },
                    { id: 7, text: "A water tank is 1/4 full. When 300 liters of water are added, it becomes 3/4 full. What is the capacity of the tank in liters?", answer: "600" },
                    { id: 8, text: "The price of a book, ₹400, first increased by 10% and then decreased by 5% on the new price. What is the final price of the book?", answer: "418" },
                    { id: 9, text: "The average weight of 4 students is 30 kg. If a new student joins the group, the new average weight becomes 32 kg. What is the weight of the new student?", answer: "40" },
                    { id: 10, text: "A group of 8 friends equally split a bill of ₹2,400. If 2 friends suddenly leave before paying, how much more does each of the remaining friends have to pay?", answer: "100" },
                ]},
                { id: 'set3', name: "Set C", questions: [
                    { id: 11, text: "The original price of a bag was 1500. After a 30% increase in price, what is the new price?", answer: "1950" },
                    { id: 12, text: "If $2x + 10 = 50$, what is the value of $x$?", answer: "20" },
                    { id: 13, text: "A cyclist rides at 15 km/hr for 4 hours. If they must complete the same distance in 3 hours, what speed is required?", answer: "20 km/hr" },
                    { id: 14, text: "A number is increased by 10% and then the result is decreased by 10%. If the final result is 99, what was the original number?", answer: "100" },
                    { id: 15, text: "What is the area of a right-angled triangle whose two sides containing the right angle are 12 cm and 5 cm?", answer: "30" },
                ]},
                { id: 'set4', name: "Set D", questions: [
                    { id: 16, text: "A group of 7 people bought tickets worth a total of ₹1050. What is the average cost of one ticket?", answer: "150" },
                    { id: 17, text: "A recipe requires $\\frac{3}{4}$ cup of flour. If you want to make half the recipe, how much flour (in cups) is needed?", answer: "3/8" },
                    { id: 18, text: "A rectangle has a perimeter of 28 cm. If the length is 8 cm, what is its width?", answer: "6" },
                    { id: 19, text: "A worker's salary is ₹20,000. If he spends 60% of his salary, how much money does he save?", answer: "8000" },
                    { id: 20, text: "The product of two numbers is 180. If one of the numbers is -12, what is the other number?", answer: "-15" },
                ]},
                { id: 'set5', name: "Set E", questions: [
                    { id: 21, text: "The ratio of two angles is 2:3. If they are supplementary (add up to $180^{\\circ}$), what is the measure of the smaller angle?", answer: "72" },
                    { id: 22, text: "If the area of a circle is $154 \\text{ cm}^2$ (use $\\pi \\approx \\frac{22}{7}$), what is its radius?", answer: "7" },
                    { id: 23, text: "In an expression, if $y=3$, what is the value of $5y^2 - 10$?", answer: "35" },
                    { id: 24, text: "A rectangular park is 20 m long and 10 m wide. If a path 1 m wide runs outside the park, what is the area of the path?", answer: "64" },
                    { id: 25, text: "A man cycles 10 km at 20 km/hr and then 10 km at 5 km/hr. What is his average speed for the whole journey?", answer: "8 km/hr" },
                ]},
                { id: 'set6', name: "Set F", questions: [
                    { id: 26, text: "Two friends, A and B, share ₹240 in the ratio 5:3. How much more money does A get than B?", answer: "60" },
                    { id: 27, text: "Find the value of $\\sqrt{169} + \\sqrt{25}$.", answer: "18" },
                    { id: 28, text: "A shopkeeper marked an item for ₹500 and sold it for ₹425. What was the percentage discount offered?", answer: "15%" },
                    { id: 29, text: "If the average of four numbers is 15, and three of the numbers are 12, 18, and 16, what is the fourth number?", answer: "14" },
                    { id: 30, text: "A watch's price is increased by 10% to ₹1100. What was the original price of the watch?", answer: "1000" },
                ]},
            ]
        };

        // --- Global State ---
        let state = {
            quizData: null,
            selectedSet: null,
            quizStarted: false,
            setChosen: false,
            currentQuestionIndex: 0,
            // inputValue will no longer be stored here for continuous input to prevent re-render loss of focus
            feedback: null, // 'correct' or 'incorrect'
            setCompleted: false,
            shuffleMessage: ''
        };
        const completionCode = MANUAL_SUBMISSION_CODE; 
        const appRoot = document.getElementById('app-root');

        // Keep track of input value separately for performance, read directly from DOM on submit
        let currentInputValue = '';


        // --- Utility Functions ---

        const shuffleArray = (array) => {
            let currentIndex = array.length, randomIndex;
            const newArray = [...array]; // Create a copy
            while (currentIndex !== 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [newArray[currentIndex], newArray[randomIndex]] = [
                    newArray[randomIndex], newArray[currentIndex]];
            }
            return newArray;
        };

        const normalizeAnswer = (answer) => {
            // Remove common symbols, spaces, and unit abbreviations for flexible checking
            return String(answer).toLowerCase().replace(/\s/g, '').replace(/[₹$%°√]/g, '').replace(/km\/hr/g, '').replace(/x=/g, '').replace(/m²|cm²|km²|m2|cm2|km2/g, '');
        };
        
        const updateState = (newState) => {
            state = { ...state, ...newState };
            renderApp();
        };

        const shuffleAllSets = () => {
            const shuffledSets = QUIZ_DATA_CONFIG.sets.map(set => ({
                ...set,
                questions: shuffleArray(set.questions) 
            }));
            updateState({ quizData: { ...QUIZ_DATA_CONFIG, sets: shuffledSets } });
        }

        const handleShuffleQuestions = () => {
            shuffleAllSets();
            updateState({ shuffleMessage: "Questions re-shuffled successfully!" });
            setTimeout(() => {
                updateState({ shuffleMessage: '' });
            }, 2000);
        }

        // --- Event Handlers ---

        const handleSetSelection = (setId) => {
            const set = state.quizData.sets.find(s => s.id === setId);
            // Reset input value when changing sets
            currentInputValue = '';
            updateState({ selectedSet: set, setChosen: true });
        };

        const handleStartQuiz = () => {
            updateState({ quizStarted: true });
        };
        
        const handleResetQuiz = () => {
            // Reset all local and global state
            currentInputValue = '';
            updateState({
                setCompleted: false,
                quizStarted: false,
                setChosen: false,
                currentQuestionIndex: 0,
                selectedSet: null,
                shuffleMessage: '',
                feedback: null
            });
        };

        // FIX: This handler now always calls renderFeedbackAndButton() to update the button's disabled state.
        const handleInputChange = (e) => {
            // 1. Update the local variable
            currentInputValue = e.target.value;
            
            // 2. Clear incorrect feedback if present
            if (state.feedback === 'incorrect') {
                state.feedback = null;
            }
            
            // 3. ALWAYS call the minimal render function to update the submit button's 
            //    disabled state and clear any incorrect feedback message.
            renderFeedbackAndButton();
        };

        const moveToNextQuestion = () => {
            const { selectedSet, currentQuestionIndex } = state;
            currentInputValue = ''; // Clear input for next question
            if (selectedSet && currentQuestionIndex >= selectedSet.questions.length - 1) {
                updateState({ setCompleted: true, feedback: null });
            } else {
                updateState({ currentQuestionIndex: currentQuestionIndex + 1, feedback: null });
            }
        };

        const handleSubmitAnswer = (e) => {
            e.preventDefault();
            const { selectedSet, currentQuestionIndex, setCompleted, feedback } = state;
            
            // Get value directly from the input element if it exists in the DOM
            const answerInput = document.getElementById('answer-input');
            const inputValue = answerInput ? answerInput.value : currentInputValue;
            currentInputValue = inputValue; // Sync local variable

            // 1. Check if set is completed or answer already correct
            if (setCompleted) return;

            if (feedback === 'correct') {
                // If the state is 'correct', clicking submit/next moves to the next question
                moveToNextQuestion();
                return;
            }

            const currentQuestion = selectedSet?.questions[currentQuestionIndex];
            if (!currentQuestion) return;

            const normalizedInput = normalizeAnswer(inputValue);
            const normalizedCorrectAnswer = normalizeAnswer(currentQuestion.answer);

            if (normalizedInput === normalizedCorrectAnswer) {
                // Set correct state, which triggers a full re-render
                updateState({ feedback: 'correct' });
            } else {
                // Set incorrect state, which triggers a full re-render
                updateState({ feedback: 'incorrect' });
            }
        };

        // NEW: Function to render only the feedback box and button, avoiding full re-render
        const renderFeedbackAndButton = () => {
            const feedbackContainer = document.getElementById('feedback-container');
            const submitButton = document.getElementById('submit-btn');

            if (!feedbackContainer || !submitButton) return;

            let feedbackHtml = '';
            let buttonText = 'Submit Solution';
            // Check currentInputValue to determine if the button should be enabled
            let buttonDisabled = !currentInputValue.trim() || state.setCompleted;
            let buttonIcon = 'chevron-right';

            if (state.feedback === 'correct') {
                feedbackHtml = `
                    <div class="text-lime-600 font-extrabold flex items-center text-xl">
                        ${icon('check-circle', 'w-7 h-7 mr-2')} Correct!
                    </div>
                `;
                buttonText = 'Next Question';
                buttonIcon = 'arrow-right';
            } else if (state.feedback === 'incorrect') {
                 feedbackHtml = `
                    <div class="text-red-600 font-semibold flex items-center text-xl">
                        ${icon('x-circle', 'w-7 h-7 mr-2')} Incorrect. Try again.
                    </div>
                `;
            }

            feedbackContainer.innerHTML = feedbackHtml;
            submitButton.innerHTML = `${buttonText} ${icon(buttonIcon, 'inline w-6 h-6 ml-2')}`;
            // Re-apply disabled state based on current input value (FIX applied here)
            submitButton.disabled = buttonDisabled;

            // Update input element styles/state if it exists
            const answerInput = document.getElementById('answer-input');
            if (answerInput) {
                 const baseClasses = "w-full px-4 py-3 border-2 rounded-xl text-xl text-gray-800 focus:outline-none shadow-inner transition duration-150";
                 let dynamicClasses = "border-gray-300 bg-gray-50 focus:border-indigo-500";
                 
                 if (state.feedback === 'correct') {
                    dynamicClasses = "border-lime-500 bg-lime-50";
                    answerInput.disabled = true;
                } else if (state.feedback === 'incorrect') {
                    dynamicClasses = "border-red-500 bg-red-100";
                    answerInput.disabled = false;
                } else {
                    answerInput.disabled = false;
                }
                answerInput.className = `${baseClasses} ${dynamicClasses}`;
            }
        }


        // --- Render Functions (Pure JS DOM Manipulation) ---

        const renderHeader = () => {
            return `
                <div class="text-center mb-8 bg-white p-4 rounded-xl shadow-lg border-b-4 border-indigo-600 w-full max-w-lg">
                    <div class="flex items-center justify-center space-x-4">
                        <img 
                            src="${SCHOOL_LOGO_URL}" 
                            alt="School Logo" 
                            class="w-auto h-12 object-contain border border-gray-200 p-1"
                            onerror="this.onerror=null; this.src='https://placehold.co/150x50/3730a3/ffffff?text=SCHOOL+LOGO'"
                        />
                        <div>
                            <h1 class="text-3xl font-extrabold text-indigo-700 mb-0">${state.quizData.title}</h1>
                            <p class="text-md text-gray-500 font-medium">${state.quizData.subtitle}</p>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderSetSelectionScreen = () => {
            const setsHtml = state.quizData.sets.map((set) => `
                <button
                    data-set-id="${set.id}"
                    class="set-select-btn flex flex-col items-center justify-center p-4 bg-indigo-50 hover:bg-indigo-600 border border-indigo-300 rounded-xl text-indigo-700 font-extrabold shadow-md hover:shadow-xl hover:text-white transition duration-150"
                >
                    ${icon('play', 'w-6 h-6 mb-1 text-indigo-500 group-hover:text-white')}
                    ${set.name}
                </button>
            `).join('');

            return `
                <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl border border-gray-200 w-full max-w-lg text-center">
                    <h2 class="text-3xl font-bold text-indigo-700 mb-6 border-b-2 pb-2">Select Your Challenge</h2>
                    <p class="text-gray-600 mb-8">Choose a set of problems to begin the challenge.</p>
                    
                    <div class="grid grid-cols-2 gap-4 md:grid-cols-3 mb-6">
                        ${setsHtml}
                    </div>
                    
                    <button id="shuffle-btn" class="w-full sm:w-auto mt-4 px-6 py-3 bg-lime-500 text-indigo-900 rounded-xl text-lg font-extrabold hover:bg-lime-600 shadow-md flex items-center justify-center mx-auto transition duration-150">
                        ${icon('refresh-cw', 'w-5 h-5 mr-2')} Shuffle All Questions
                    </button>
                    <p id="shuffle-message" class="mt-3 text-sm text-lime-600 font-semibold min-h-[20px]">
                        ${state.shuffleMessage}
                    </p>
                </div>
            `;
        };
        
        const renderInstructionScreen = () => {
            const setName = state.selectedSet.name;
            return `
                <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl border-4 border-lime-500 w-full max-w-lg text-gray-800">
                    <h2 class="text-3xl font-extrabold text-indigo-600 mb-4 flex items-center">
                        ${icon('book-open', 'w-8 h-8 mr-3 text-lime-500')} Instructions for ${setName}
                    </h2>
                    
                    <div class="space-y-4 text-gray-600">
                        <p class="text-lg font-semibold border-b border-gray-300 pb-2">
                            This is an untimed challenge. Focus on accuracy!
                        </p>
                        
                        <ul class="list-disc list-inside space-y-2 ml-4 text-left text-sm md:text-base">
                            <li>
                                <span class="font-bold text-indigo-500">Answering:</span> Type your final answer in the text box. Click "Submit" to check.
                            </li>
                            <li>
                                <span class="font-bold text-indigo-500">Immediate Feedback:</span> The system will check for correctness instantly.
                            </li>
                            <li>
                                <span class="font-bold text-indigo-500">No Penalty:</span> You may try again until the answer is correct before moving to the next question.
                            </li>
                            <li>
                                <span class="font-bold text-indigo-500">Completion:</span> Upon correctly answering all questions, a unique code will be displayed for submission.
                            </li>
                            <li class="font-bold text-lime-600">
                                <span class="font-bold">Math Notation:</span> Use standard numbers, fractions (e.g., 3/8), or required units.
                            </li>
                        </ul>
                        
                        <div class="p-3 bg-lime-50 border border-lime-400 rounded-lg flex items-center mt-6">
                            ${icon('alert-triangle', 'w-5 h-5 mr-2 text-lime-600 flex-shrink-0')}
                            <p class="text-sm">
                                <span class="font-bold text-lime-600">Ready?</span> The challenge begins immediately after clicking the button below.
                            </p>
                        </div>
                    </div>
                    
                    <button id="start-quiz-btn" class="mt-8 w-full bg-indigo-600 text-white py-3 rounded-xl text-xl font-extrabold hover:bg-indigo-700 shadow-xl transition duration-150">
                        Start Challenge ${icon('chevron-right', 'inline w-6 h-6 ml-2')}
                    </button>
                </div>
            `;
        };

        const renderQuestionCard = () => {
            const currentQuestion = state.selectedSet.questions[state.currentQuestionIndex];
            const isIncorrect = state.feedback === 'incorrect';
            const questionNumber = state.currentQuestionIndex + 1;
            const totalQuestions = state.selectedSet.questions.length;
            
            const baseClasses = "w-full px-4 py-3 border-2 rounded-xl text-xl text-gray-800 focus:outline-none shadow-inner transition duration-150";
            let dynamicClasses = "border-gray-300 bg-gray-50 focus:border-indigo-500";

            if (state.feedback === 'correct') {
                dynamicClasses = "border-lime-500 bg-lime-50";
            } else if (isIncorrect) {
                dynamicClasses = "border-red-500 bg-red-100";
            }

            return `
                <div class="bg-white text-gray-800 p-6 md:p-8 rounded-xl shadow-2xl border-t-8 border-indigo-600 w-full max-w-lg">
                    
                    <div class="flex justify-between items-center mb-6 border-b border-gray-200 pb-4">
                        <h2 class="text-2xl font-semibold text-indigo-600">
                            ${state.selectedSet.name}
                        </h2>
                        <div class="text-lg font-bold text-gray-500 flex items-center">
                            ${icon('hash', 'w-5 h-5 mr-1')} Q ${questionNumber} of ${totalQuestions}
                        </div>
                    </div>

                    <div class="mb-8 min-h-[80px]">
                        <p class="text-2xl text-gray-800 font-bold leading-relaxed question-text">${currentQuestion.text}</p>
                    </div>

                    <form id="answer-form" class="space-y-4">
                        <input
                            type="text"
                            id="answer-input"
                            value="${currentInputValue}"
                            placeholder="Your Solution Here..."
                            class="${baseClasses} ${dynamicClasses}" 
                            ${state.feedback === 'correct' ? 'disabled' : ''}
                            autocomplete="off"
                        />

                        <div id="feedback-container" class="min-h-10 flex items-center justify-center">
                            ${state.feedback === 'correct' ? `
                                <div class="text-lime-600 font-extrabold flex items-center text-xl">
                                    ${icon('check-circle', 'w-7 h-7 mr-2')} Correct!
                                </div>
                            ` : ''}
                            ${isIncorrect ? `
                                <div class="text-red-600 font-semibold flex items-center text-xl">
                                    ${icon('x-circle', 'w-7 h-7 mr-2')} Incorrect. Try again.
                                </div>
                            ` : ''}
                        </div>

                        <button
                            type="submit"
                            id="submit-btn"
                            class="w-full bg-indigo-600 text-white py-3 rounded-xl text-2xl font-extrabold hover:bg-indigo-700 shadow-xl disabled:opacity-50 transition duration-150"
                            ${!currentInputValue.trim() || state.setCompleted ? 'disabled' : ''}
                        >
                            ${state.feedback === 'correct' ? 'Next Question' : 'Submit Solution'}
                            ${icon(state.feedback === 'correct' ? 'arrow-right' : 'chevron-right', 'inline w-6 h-6 ml-2')}
                        </button>
                    </form>
                </div>
            `;
        };

        const renderCompletionScreen = () => {
            const copied = appRoot.dataset.copied === 'true'; // Use a data attribute for state
            
            return `
                <div class="bg-white text-gray-800 p-8 md:p-12 rounded-xl shadow-2xl w-full max-w-lg text-center border-8 border-lime-500">
                    
                    ${icon('check-circle', 'w-16 h-16 text-lime-500 mx-auto mb-4')}
                    
                    <h2 class="text-4xl font-extrabold mb-2 text-indigo-700">
                        SET COMPLETED!
                    </h2>
                    <p class="text-xl font-semibold mb-8 text-gray-600">
                        You successfully completed the **${state.selectedSet.name}** challenge.
                    </p>

                    <div class="mb-8 p-4 bg-gray-100 rounded-lg border border-lime-400">
                        <p class="text-md font-medium text-lime-600 flex items-center justify-center mb-2">
                            ${icon('hash', 'w-5 h-5 mr-1')} Your Submission Key
                        </p>
                        <div class="flex items-center justify-center space-x-3">
                            <span class="text-3xl font-mono tracking-widest text-indigo-700 bg-white p-3 rounded border border-dashed border-indigo-300 select-all shadow-inner">
                                ${completionCode}
                            </span>
                            <button
                                id="copy-btn"
                                class="p-4 rounded-full shadow-lg transition duration-150 ${copied ? 'bg-lime-600 text-white' : 'bg-indigo-600 text-white hover:bg-indigo-700'}"
                                aria-label="Copy code to clipboard"
                            >
                                ${icon('clipboard', 'w-6 h-6')}
                            </button>
                        </div>
                        <p class="text-xs text-lime-600 mt-2 font-semibold min-h-[16px]">
                            ${copied ? 'Key Copied!' : ''}
                        </p>
                    </div>

                    <p class="text-lg text-gray-600 mb-6">
                        Submit this key in the form below to register your completion for **${state.selectedSet.name}**.
                    </p>

                    <a
                        href="${state.quizData.googleFormLink}"
                        target="_blank"
                        rel="noopener noreferrer"
                        class="inline-flex items-center justify-center w-full py-3 rounded-xl text-xl font-extrabold shadow-xl bg-lime-500 hover:bg-lime-600 text-indigo-900 mb-4 transition duration-150"
                    >
                        ${icon('file-text', 'w-6 h-6 mr-2')} Go to Submission Form
                    </a>
                    
                    <button
                        id="reset-quiz-btn"
                        class="inline-flex items-center justify-center w-full py-3 rounded-xl text-xl font-extrabold shadow-md bg-gray-200 hover:bg-gray-300 text-indigo-600 transition duration-150"
                    >
                        ${icon('arrow-left', 'w-6 h-6 mr-2')} Start Another Set
                    </button>
                </div>
            `;
        };
        
        // --- Main Render Function ---
        const renderApp = () => {
            if (!state.quizData) {
                // Initial loading state
                appRoot.innerHTML = `
                    <div class="text-xl text-indigo-700">Loading MathMania Quiz...</div>
                `;
                return;
            }

            let contentHtml = '';
            
            if (state.setCompleted) {
                contentHtml = renderCompletionScreen();
            } else if (!state.setChosen) {
                contentHtml = renderSetSelectionScreen();
            } else if (!state.quizStarted) {
                contentHtml = renderInstructionScreen();
            } else {
                contentHtml = renderQuestionCard();
            }

            appRoot.innerHTML = `
                ${renderHeader()}
                <div class="relative z-10 w-full max-w-lg">
                    ${contentHtml}
                </div>
            `;
            
            // --- Re-attach Event Listeners (Crucial for pure JS rendering) ---

            // 1. MathJax Rerender (for LaTeX in questions)
            if (window.MathJax) {
                window.MathJax.typesetPromise();
            }

            // 2. Set Selection Buttons
            document.querySelectorAll('.set-select-btn').forEach(button => {
                button.onclick = () => handleSetSelection(button.dataset.setId);
            });

            // 3. Shuffle Button
            const shuffleBtn = document.getElementById('shuffle-btn');
            if (shuffleBtn) {
                shuffleBtn.onclick = handleShuffleQuestions;
            }

            // 4. Start Quiz Button
            const startQuizBtn = document.getElementById('start-quiz-btn');
            if (startQuizBtn) {
                startQuizBtn.onclick = handleStartQuiz;
            }

            // 5. Answer Form Submission
            const answerForm = document.getElementById('answer-form');
            if (answerForm) {
                answerForm.onsubmit = handleSubmitAnswer;
            }

            // 6. Answer Input (Input changes now only update local variable and minimal feedback)
            const answerInput = document.getElementById('answer-input');
            if (answerInput) {
                // Attach the input handler to update local state and enable the button
                answerInput.oninput = handleInputChange; 
                // Fix for the cursor focus loss:
                answerInput.focus();
                // If it's a correct answer, disable it on render
                if (state.feedback === 'correct') {
                    answerInput.disabled = true;
                }
            }
            
            // 7. Copy Button (Completion Screen)
            const copyBtn = document.getElementById('copy-btn');
            if (copyBtn) {
                copyBtn.onclick = () => {
                    const el = document.createElement('textarea');
                    el.value = completionCode;
                    document.body.appendChild(el);
                    el.select();
                    // Use document.execCommand('copy') for better compatibility in iframe/sandbox environments
                    document.execCommand('copy'); 
                    document.body.removeChild(el);

                    appRoot.dataset.copied = 'true';
                    renderApp(); // Rerender to show "Copied" message/style change
                    setTimeout(() => {
                        appRoot.dataset.copied = 'false';
                        renderApp();
                    }, 2000);
                };
            }
            
            // 8. Reset Quiz Button (Completion Screen)
            const resetBtn = document.getElementById('reset-quiz-btn');
            if (resetBtn) {
                resetBtn.onclick = handleResetQuiz;
            }
        };

        // --- Initial Setup and Security ---

        // Security: Prevent context menu and F12
        document.addEventListener('contextmenu', (e) => e.preventDefault());
        document.addEventListener('keydown', (e) => {
            if (e.key === 'F12') e.preventDefault();
        });
        
        // Start the application
        window.onload = () => {
            shuffleAllSets(); // Initializes state.quizData and renders the app
        };

    </script>
</body>
</html>
